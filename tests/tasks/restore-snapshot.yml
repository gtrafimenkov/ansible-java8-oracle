---

- name: Get list of snapshots
  local_action: "command vagrant snapshot list {{inventory_hostname}}"
  register: snapshots_result
  changed_when: false
  when: vagrant_vm|bool

- name: First boot and snapshot creation
  local_action: "shell vagrant up {{inventory_hostname}} && vagrant halt {{inventory_hostname}} && vagrant snapshot save {{inventory_hostname}} ready-for-tests"
  when: vagrant_vm|bool and not ('ready-for-tests' in snapshots_result.stdout)

- name: Restore snapshot
  local_action: "command vagrant snapshot restore --no-provision {{inventory_hostname}} ready-for-tests"
  when: vagrant_vm|bool and ('ready-for-tests' in snapshots_result.stdout)
